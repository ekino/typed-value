name: Publish Release

on:
  push:
    tags:
      - "v*" # Unified release: v1.0.0 publishes all artifacts

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: "corretto"
          java-version: "21"

      - name: Cache Gradle dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Extract version information
        id: version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "artifact_version=$VERSION" >> $GITHUB_OUTPUT

          echo "Publishing version: $VERSION"
          echo "Artifacts to be published:"
          echo "  - typed-value-core:$VERSION (JVM, JS)"
          echo "  - typed-value-jackson:$VERSION"
          echo "  - typed-value-spring:$VERSION"
          echo "  - typed-value-hibernate:$VERSION"
          echo "  - typed-value-querydsl:$VERSION"
          echo "  - typed-value-spring-data-elasticsearch:$VERSION"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build all modules
        run: ./gradlew build -x test

      - name: Run tests
        run: ./gradlew test

      - name: Publish to Maven Central
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralUsername }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_mavenCentralPassword }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKey }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_signingInMemoryKeyPassword }}
        run: |
          echo "Publishing to Maven Central..."
          ./gradlew publish --no-daemon --stacktrace

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts-${{ steps.version.outputs.artifact_version }}
          path: |
            **/build/libs/*.jar
          retention-days: 90

      - name: Find release notes file
        id: release_notes
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          NOTES_FILE="release-notes/RELEASE_NOTES_${TAG_NAME}.md"

          if [ -f "$NOTES_FILE" ]; then
            echo "notes_file=$NOTES_FILE" >> $GITHUB_OUTPUT
            echo "has_notes=true" >> $GITHUB_OUTPUT
          else
            echo "has_notes=false" >> $GITHUB_OUTPUT
            echo "⚠️ Release notes file not found: $NOTES_FILE"
          fi

      - name: Detect prerelease
        id: prerelease
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          if [[ "$TAG_NAME" =~ -(alpha|beta|rc|RC|snapshot|SNAPSHOT) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            **/build/libs/*.jar
          body_path: ${{ steps.release_notes.outputs.has_notes == 'true' && steps.release_notes.outputs.notes_file || '' }}
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease == 'true' }}
          generate_release_notes: ${{ steps.release_notes.outputs.has_notes != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
